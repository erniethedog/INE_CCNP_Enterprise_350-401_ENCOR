======================================================================
CLASSIC EIGRP

Configuring Classic EIGRP
Verifying EIGRP Adjacencies
Verifying EIGRP Topology

Classic EIGRP 
- EIGRP prior to IOS 15.X
- AKA EIGRP Autonomous System Configuration
  > Process name is the AS number
- Administrative Distance of 90
- Well known Multicast address for EIGRP process = 224.0.0.10
- Internet Protocol 88 (own transport)
- uses Realiable Transport Protocol (RTP) - not to be confused with Real Time Protocol

BGP uses TCP under port 179
RIP uses UDP



Enabling Classic EIGRP
- Enable global process
  > router eigrp [AS]
  > AS number must match to be adjacent
- Enable the interface process
  > network [address] [wildcard]
    - no wildcard mask, it defaults to classful mask
    - This does not mean that EIGRP advertises the subnet. EIGRP is just turned ON on interface/s with that subnet
    - But if EIGRP is turned on on that interface, EIGRP advertises that interface
    - In BGP, the network statement is used to advertise the prefix
                        
  > similar to OSPF network statement

Verifying EIGRP
- Verify EIGRP
  > show ip eigrp interfaces [detail]
  > show ip protocols
- Verify EIGRP transport
  > debug eigrp packet [hello|ack|update|query|reply...]
- Verify neighbor adjacencies
  > show ip eigrp neighbors [detail]
  > Queue count should be 0 if converged. If queue count is NOT 0, neighbors are not adjacent
  > EIGRP uses multicast and unicast
  > Sequence number = increment to ack the updates. basically, peers have to agree on this seq num. part of protocol reliability
  > SRTT = Smooth Round Trip Time - one way to check if there are layer 1 issues
- Verifying  EIGRP topology
  > show ip eigrp topology [all-links]
    - By default, only the successors are show. need all-links to show the other routes
  > show ip eigrp topology [prefix/len]
  
Goes to selection process - feasibility condition
the ones who win the feasib condition become the successors
Successor are the candidates installed on the Routing Table
  
This is different to OSPF, ISIS, and BGP
Separation of information used for advertising and info to route traffic

OSPF - sync database within the are. not necessarily mean it is used for routing

For EIGRP, since EIGRP does not have a overall view of the network. They only know advertisement from directly connected neighbors
If EIGRP is learning a route, but it does not install on the routing table, it means EIGRP does not advertise the route


show ip protocols
- shows protocols running
- under EIGRP
  > NSF - non stop forwarding
  > MTR - Multiple Topology Routing - for EIGRP Named Mode
  > Routing for Networks
    - see networks in which EIGRP is running
  > Routing Information Sources
    - to check if you are receiving routes from a neighbor
    - list of neighbors that are advertising on EIGRP


Forming Neighbor adjacency is on multicast
once neighbors are adjacent, unicast is used to send updates to peers
Source IP is, of course, the router ID


show ip eigrp topology [IP] [subnet mask]
  - State = Passive. Used for forwarding. EIGRP is converged. Active = running reconvergence process
  - Feasible Distance = Metric
  - Number of Successors
  - (Feasible Distance / Advertised Distance)
    > FD - Metric the router is using
    > AD - Metric the upstream neighbor is using
    > Normally FD > AD, since router needs to consider values in calculation to get to the upstream neighbor
    > If FD < AD, EIGRP will think that there is a loop in the network


show ip route [eigrp]
- status code of D

EIGRP timers does not need to match for the protocol to work
Normally, these are set as the same, but it is not needed
There is always BFD or layer 1 link detection to check adjacencies

======================================================================
EIGRP NAMED MODE

- also called EIGRP Multi-AF (Address Family) Mode
- Better configuration heirarchy
  > old syntax is not that intuitive
  > all config now goes under global process
- better feature parity between ipv4 and ipv6
  > syntax is unified for IPv4 and IPv6 under one process
  > uses address-families to distinguish v4 and v6
- Newer feature arent supported in Classic Mode
  > Wide Metrics, IPv6 VRF Lite, etc
  
Configuration
- Enable the global process
  > router eigrp [name]
  > name is not the AS number
  > ie. router eigrp DANCEDRIC
    - Name is locally significant
- Enable the address-family
  > address-family ipv4 unicast autonomous-system 1
- Enable the interface process
  > network [address] [wildcard]
  > similiar to OSPF network statement
- Customize the interface
  > af-interface [default|int]
    - default - configuration for all interfaces

! topology base = not using multiple topology
- All interfaces are under base topology by default
- features that is global on the process goes under topology base, ie. redistribute list


MTR = Multiple Topology Routing
- like MPLS traffic engineering
- ie. different topology for voice, multicast, and video

Wide Metrics - used in Named Mode
> show ip eigrp topology [network]
  - Delay is in picoseconds
> very granular delay values to accomodate high speed links like 100GigE
> automatic on the process

Converting EIGRP Classic to Named Mode
> eigrp upgrade-cli
> Conversion is hitless 
  - performs graceful restart automatically. neighbor will say the it needs to restart adjacency
  - adjacencies will flap but data plane will still work
  - Graceful restart = Non-stop forwarding = non-stop routing
    > NSF / NSR = cisco proprietary term
    > graceful restart = standard term
> supports both IPv4 and IPv6 EIGRP
  - can be in different AS

======================================================================
EIGRP CLASSIC METRIC CALCULATION


- EIGRP Classic Metric Calculation
  > lowest composite metric based on
    - Bandwidth
      > Inverse lowest bandwidth along path in Kbps scaled by (10^7 * 256)
        - ie. BW is 1000000 Kbps
        - (10^7 * 256) / 1000000
        - BW = 2560
    - Delay
      > Cumulative delay along path in tens of microseconds (us) scaled by 256
        - ie. Delay is 5010 microseconds
        - Delay = 501 * 256 = 128256
    - Load
      > highest load along path
    - Reliability
      > lowest reliability along path
  > normally, only BW and Delay are used, since Load and Reliabiity change over time
  > Composite metric is computed as 
    - metric = [k1 * BW +(k2 * BW)/(256 - load) + k3 * delay]
    - if k5 != 0, metric = metric * [k5/(reliability + k4)]
  > K values allow for manual weighting
    - defaults are K1 = 1, K2 = 0, K3 = 1, K4 = 0, K5 = 0
    - implies default composite is (BW + delay)
  > can be modified with "metric weights" command
    - must match for adjacency to establish


Note that BW value on the link is also used on other applications, like QoS or calculations by neighboring routers
  - BW is used on a per prefix (routers connected to the same switch under one subnet)
So, Delay is generally modified for traffic engineering (if you want to chose one path over the other)
  - Delay is cumulative on a hop by hop basis

Command:
metric weights [TOS] [k1] [k2] [k3] [k4] [k5]
!k6 - used in named mode
metric weights 0 0 0 1 0 0
!changing K1 value to 0

Note:
In IGP, you change link attribute, route is affected
In BGP, attribute is owned by the route, not by the link

======================================================================
EIGRP WIDE METRICS

- only on Named Mode
- running by default

Classic EIGRP BW Metric Problem
- As BW increases, visibility is lost
  > 1GigE = 2560
  > 10G = 256
  > 20G = 256
  > 40G = 256
  > 100G = 256

Delay Problem
- Min configurable delay in IOS is 10us (10 microseconds)
- As BW increases, visibility is lost
  > 1GigE = 10us
  > 10G = 10us
  > 20G = 10us
  > 40G = 10us
  > 100G = 10us

EIGRP Wide Metrics
- Wide Metric is now 64 bits
- BW problem fixed by scaling higher
  > WIDE_EIGRP_BW = 10^7 * 65536 / INT_BW
  > INT_BW in Kbps
- Delay Problem fixed by moving to picoseconds
  > WIDE_EIGRP_DLY = DLY_PICO * 65536 / 10^6
  
EIGRP Wide Metric Formula
- BW is now Throughput
  > Throughput = K1 * (EIGRP_BANDWIDTH * EIGRP_WIDE_SCALE) / Interface_BW (Kbps)
- Delay is now Latency
  > Latency = K3 * (DELAY * EIGRP_WIDE_SCALE) / EIGRP_DELAY_PICO
- Default metric is still the same formula
  > metric = (K1 * min(Throughput)) + (K3 * sum(Latency))

EIGRP_WIDE_SCALE = 65536
EIGRP_CLASSIC_SCALE = 256
EIGRP_RIB _SCALE = 128 
  > some metrics are too large to be displayed on the routing table
  > this is used to scale down the metric, then install it on the RIB (routing table)
  > metric rib-scale [VALUE]        !under eigrp named config
  > this is only locally significant on the router
  
EIGRP Wide Metric Config
- Enable EIGRP named mode
- Wide metrics automatically enabled
- Still backwards compatible with classic


EXAMPLE Calculation:
Min BW is 1000000 Kbit
Total delay is 11250000 picoseconds

WIDE_EIGRP_BW = 10^7 * 65536 / 1000000
              = 655360
WIDE_EIGRP_DLY = 11250000 * 65536 / 10^6
               = 737,280
Metric = (K1 * 655360) + (K3 * 737,280)
       =  1,392,640
RIB = Metric / EIGRP_RIB _SCALE
    = 10880  <-------!!!! This is the metric seen on the routing table
       

======================================================================
EIGRP TRAFFIC ENGINEERING AND UNEQUAL COST LOAD BALANCING


EIGRP Feasibility Condition
- Feasibility Condition (FC) is used to select loop-free backup paths
  > Paths meeting the FC are pre-computed during DUAL (Diffusing Update ALgorithm)
- Pre-computed backup paths have multiple advantages
  > Sub-second reconvergence when primary path fails
  > Fault isolation (doesnt need flooding event like in OSPF)
  > Unequal cost load distribution
    - Not necesssarily used for applications like voice
    - In practice, UCLB is not that used. Main advantage is that EIGRP has pre-computed backup paths


Feasibility Condition High Level Overview
- First, find the best path
  > Take the metric of the best path as X
- Next, find alternate backup paths
  > Anyone with a metric less than X is closer to the destination than me
  > Exclude anyone with a metric greater than or equal to X
    - EIGRP will believe that a loop is present on metrics greater than its own


Feasibility Condition Terminology
- Successor
  > Best path to a destination
  > this is the one installed in the routing table    
- Feasible Distance (FD)
  > composite metric of best path (successor)
- Reported Distance (RD) or Advertised Distance
  > composite metric learned from neighbors
- Feasible Successors (FS)
  > Backup paths that meet the Feasibility Condition
  
Feasibility Condition in Detail
- Once best path is chosen, additional paths are examined for backup routes
- FC finds loop-free backup routes via logic
  > if RD < FD, path is loop-free and viable backup
  > eg. if your metric is lower than mine, you are closer to the destination and route is loop-free
- Paths that meet FC are Feasible Successors (FS)
  > Only FS can be used for unequal cost load balancing
  
On show eigrp toplogy command, FD and RD is shown as
- Composite metric is (FD/RD)


EIGRP Reconvergence
- Reconvergence differ for paths with or without an FS
- Paths without an FS
  > Loss of Successor send route into Active state
  > Send QUERY to all neighbors
  > Reconverged when REPLY heard from all neighbors
- Paths with FS
  > Loss of Successor does NOT make route Active
  > FS promoted to Successor
  > Query NOT generated
  > Result is sub second convergence


NOTE that BFD is normally used to detect down links
BFD is usually offloaded on the Hardware/ASICs, so, detection is really fast and the router doesnt have to rely on the CPU
- show bfd neighbor
- show bfd neighbor [detail]
  > you can see the registered protocol for the BFD
  > BFD basically tells upper layer protocols that link is dead
 
 
interface GigabitEthernet1/0.37
 bfd interval 250 min_rx 250 multiplier 3
router eigrp NAME
 !
 address-family ipv4 unicast autonomous-system 100
  !       
  af-interface GigabitEthernet1/0.37
   bfd
  exit-af-interface



Modifying EIGRP Path Selection
EIGRP Unequal Cost Load Balancing


EIGRP Traffic Engineering
- Default EIGRP composite metric is BW + delay
  > based on default K1 and K3 metric weights
- BW is lowest BW along the path on a per prefix basis
  > Essentially the BW bottleneck
  > Hard to predict what a modification will affect
- Delay is cumulative on a hop-by-hop basis
  > Easier to influence path selection with
  > modified with delay interface command
  
- check the traffic share in the routing table to check load balancing ratio
  > 1st route: traffic share count is 48
  > 2nd route: traffic share count is 1
  > traffic share ration is 48 to 1

- EIGRP allows load distribution among unequal paths
  > only FS are candite for load balancing
- Controlled by variance command
  > If (FD * variance) > FS, load balancing occurs
- Traffic share is automatically calculated
  > Links used in a ratio proportional to their composite metrics
  > Actual load balancing still controlled by switching path 
    - EG. CEF per-flow


======================================================================
EIGRP CLASSIC AUTHENTICATION

- Support two types of Authentication
	> MD5
	> HMAC-SHA-256
	
- MD5 Authentication
	> Both Classic and Named EIGRP
	> Uses key chains
	> Supports automatic key rotation
	
- SHA Authentication
	> Only on NAMED EIGRP
	> No key chains or rotations
	
	
Classic EIGRP Authentication
- Supports MD5 only
	> HASH of the password is exchanged
	> on packet capture, you can still see the routes in plain text format
- Define key chain globally
	> Whitespace counts as a characte
	> Key number must match. EIGRP starts on lowest number, going up
	> supports automatic key rotation
- Applied at interface level
	> ip authentication mode eigrp [AS] md5
	> ip authentication key-chain eigrp [AS] [key-chain]
	
	
conf t
key chain <NAME>
	key 1
		key-string password <PASSWORD>			!!!!take note that whitespace is a character

interface gi1.146
	ip authentication mode eigrp <AS> md5
	ip authentication key-chain eigrp 1 <KEY_CHAIN>
	
show key chain

On logs:
missing authentication - peer has no authentication configured
invalid authentication - peer has wrong key OR key number 
	
	
Automatic KEY Rotation
- Key Chain suppors multiple key numbers
	> Router always send lowest valid key
	
- Key number's validity is based on time
	> accept-lifetime
		- when key is valid to be received
	> send-lifetime
		- when key is valid to be snet

- Automatic rotaton by defining different validity times
	> implies time must be agreed upon. NTP
	> accept-lifetime should overlap in case of mismatch of time 
	

======================================================================
EIGRP AUTOMATIC KEY ROTATION


======================================================================
EIGRP NAMED MODE AUTHENTICATION


======================================================================
EIGRP SUMMARIZATION


======================================================================
EIGRP TRAFFIC ENGINEERING WITH SUMMARIZATION


======================================================================
EIGRP OVER DMVPN


======================================================================
EIGRP STUB ROUTING


======================================================================
EIGRP ROUTE FILTERING


======================================================================
