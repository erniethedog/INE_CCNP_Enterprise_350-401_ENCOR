======================================================================
Open Shortest Path First (OSPF) Protocol & Operation Overview

Resources:
- OSPF: Anatomu of an Internet Routing Protocol
- Routing TCP/IP Volume 1
- Cisco IP Routing: Packet Forwarding and Intra-domain Routing Protocols

Standards:
- RFC 2328
  > OSPF Version 2 
  > for IPv4
- RFC 5340
  > OSPF for both IPv4 and IPv6
  
Technology Documentation
- Cisco > Technology > IP > IP Routing > OSPF
- OSPF Configuration Guides

What is OSPF?
- RFC 2328
  > OSPF Version 2 
  > for IPv4
- RFC 5340
  > OSPF Version 3
  > OSPF for both IPv4 and IPv6
  > Multi-AF support for v3
- Link-State Protocol
  > Uses Dijkstra SPF Algorithm
- Classless
  > Supports VLSM and Summarization
  
Why USE OSPF
- Guarantees a Loop-Free Topology
  > All routes agree on overall topology
    - All routers on the same area has the same view of the topology
  > Uses Dijkstra SPF Algorithm for calculation
    - Input: LSA Database (in the area)
    - Output: Shortest Path Tree; used for routing
- Standards based
  > Inter-operability between vendors
- Large Scalability
  > Hierarchy through 'areas'
    - 2 level heirarchy
  > Topology summarization
- Fast Convergence
  > Actively tracks neighbor adjacencies
    - "hello"
  > Event driven incremental updates
  > Subsecond convergence when configured properly
- Efficient Updating
  > Uses reliable multicast and unicast updates
  > Non-OSPF devices do not need to process updates
- Bandwidth Based Cost Metric
  > More flexible than static hop count
- Control Plane Security
  > Supports multiple forms of authentication
    - eg. Clear Test, MD5, SHA, IP Sec, etc
- Extensible
  > Future application support through "opaque" LSA
    - eg. MPLS Traffic Engineering
  > unlike EIGRP which is "closed" standard even though it has an informational standard
  
  
HOW OSPF WORKS
1. Discover OSPF Neighbors and Exchange Topology
2. Choose best path via SPF
  Input: LSA Database (in the area)
  Process by SPF Algo
  Output: Shortest Path Tree
3. Neighbor and Topology Table Maintenance

Step 1 - Neighbor and Topology Discovery
- like EIGRP, OSPF uses "hello" packets to discover neighbors on OSPF enabled attached links
  > Transport via IP protocol 89 (OSPF). Not using TCP/IP transport
  > Sent as multicast to 224.0.0.5 or 224.0.0.6, or unicast
- Hello packet contain attributes that neighbors must agree on to form "adjacency"
  > Once adjacency is negotiated, LSDB is exchanged
    - Some devices will form neighbor relationships but NOT adjacencies
    - Devices that form adjacency will form neighbor relationships
  
Negotiating OSPF Adjancies
- OSPF adjacency occurs when connected neighbors use hello packets to agree on unique and commn attributes
  > Not all OSPF neighbors actually form adjacency
  > Most OSPF configuration problems happen at this stage
    - like MTU mismatch, wrong authentication, or Layer 2 errors
    
Unique OSPF Adjacency Attributes
- Router-ID
  > Node ID in the Link State Graph
    - BGP is used to do destination routing. OSPF is used to route packets between nodes in the graph
    - OSPF is making decision based on the node identifier in the graph, which is the Router-ID
  > Chosen based upon:
    - Manual Configuration (Recommended)
    - Highest active Loopback IP
    - Highest active Interface IP
  > must be unique on the whole OSPF topology. not just in one area
- Interface IP Address
  > For OSPFv2, the interface' primary IP Address
  > For OSPFv3, the interface' link-local address
    - This is unique on IPv6 because of Duplicate Address Detection (DAD)

Common OSPF Adjacency Attributes
- Interface Area ID
- Hello interval and Dead interval
- Interface network address
- Interface MTU
  > eg. jumbo MTU on GigE
- Network Type
- Authentication
- Stub Flags
- Other optional capabilities

OSPF Hello Packets
- OSPF routers periodically send hello packets out to OSPF enabled links everyt Hello interval
- Hello packet contains
  > Local Router ID
  > Local Area ID
  > Local Interface Subnet Mask
  > Local Interface Priority
  > Hello interval
  > Dead interval
  > Authentication Type and Password
  > DR/BDR Addresses
  > Options (eg. stub flags, etc)
  > Router IDS of other neighbor on the link

OSPF Adjacency State Machine
- OSPF adjacency process uses 8 states to determine progress of adjacency establishment
  1. Down
    - No hellos have been received from neighbor
  2. Attempt
    - UNICAST HELLO packet has been sent to neighbor, but no hello has been received back
    - Only used for manually configured NBMA neighbors
    - If OSPF is running on Frame Relay (non-broadcast network type) or DMVPN (non-broadcast network type), state changes from DOWN TO ATTEMPT  
  2. Init
    - MULTICAST HELLO
    - Have received a hello packet from a neighbor, but they have not acknowledged a hello from me
    - If OSPF is running on Ethernet, state changes from DOWN to INIT (not just Ethernet, any other network types which is non broadcast goes to INIT after DOWN)
		- Stuck here = transport problem. check protocol filtering on ACL as well
  3. 2-Way
    -  I have received a hello packet from a neighbor and they have acknowledged a hello from me
      > indicated by my Router-ID in the neighbor's hello packet
    - If state does NOT go to 2-Way state, there must be something wrong in the Layer 2 transport network
      > OSPF is filtered 1 way
      > Multicast is not supported
      > some sort of any Layer 1 issue
  4. ExStart (Exchange Start)
    - First Step of actual adjacency. Negotiate attributes for adjacency
    - If stuck at this state, debug will show the issue. OR do a stare and compare on the attributes
    - Master and Slave Relationship is formed (Master has higher Router-ID)
    - Master chooses the starting sequence number for the DBD (Database Descriptor) packets that are used for actual LSA exchange
    - basically used for collisions (messages sent at the same time)  
  5. Exchange
    - Local link state database is sent through DBD packets
    - DBD sequence number is used for reliable acknowledgement/retransmission
  6. Loading
    - Link State Request packets are sent to ask for more information about a PARTICULAR LSA (not the whole Database)
    - Distance vector is routing based on destination prefixes. Link state is routing based on the nodes in the graph
  7. Full
    - Neighbors are fully adjacent and databases are synchronized
    - SPF can now be run

Step 2 - Choose Best Path via SPF
- Once the databases are synchronized, path selection begins
- Each router's LSA include a "cost" attribute for each described link
  > Best Path to that link is lowest end-to-end cost
  > Multiple Equal Cost Paths are allowed (ECMP)
- There exists an issue with OLD OSPF code and NEW OSPF
  > need to tell OSPF to account for high speed links
    - eg. GigE, TenGigE, HundredGigE, FortyGigE
- Cisco's implementation uses Bandwidth based cost, but per RFC, it is arbitrary
  > Default Cisco Cost = 100 Mbps / Link Bandwidth
  > Reference BW can be modified to accommodate higher speed links (eg. GigE, TenGigE, HundredGigE, FortyGigE)
  > As long as peer routers agree on the cost, traffic will be routed
  
Step 3 - Neighbor and Topology Maintenance
- Once adjacencies established and SPT built, OSPF State machine tracks neighbor and topology changes
  > Hello packets used to track neighbor changes
  > LSA fields used to track topology changes

Tracking Neighbor Changes
- Hello Interval
  > 10 or 30 seconds by default depending on interface type
- Dead Interval
  > defaults to 4 x Hello interval
  > can be as low as 1 second for faster convergence
- BFD can also be used to for faster convergence
- When a new LSA is received, it is checked against the database for changes such as:
  > Sequence number
    - higher seq number means newer copy of LSA
    - there are instances when the LSA has higher seq number but nothing has changed
  > Age
    - Used  to keep information new and withdraw old information
    - Periodic flooding occurs after 30 mins
      > "paranoid" update
    - LSA that reach MaxAge (60 mins) are withdrawn
    - MaxAge is used to poison routes (make routes disappear on the update)
  > Checksum
    - Used to avoid transmission and memory corruption

LSA Flooding
- When change is detected, new LSA is generated and flooded out all links
  > OSPF does not use split horizon
  > Self-originated LSAs are simply dropped
- Not all LSA changes require SPF to recalculate
  > eg. link up/down event vs seq number change
  > See RFC 2328 "13. The Flooding Procedure" for details

Note: OSPF behaves as a distance vector for Inter-Area Routing

======================================================================

OSPF Single Area Configuration

Configuring Basic OSPF
Verifying OSPF Adjacencies
Verifying OSPF Database


OSPF Prerequisites
- IP Routing must be enabled
  > eg. "ip routing" command
- Must be an up/up interface running IP
  > used for OSPF Router-ID when OSPF starts
  > not an IP address. just a 32 bit number inherited from IP address
  
Enabling OSPF
- Enable global OSPF process
  > router ospf [process-id]
    - process-id is locally significant
    	> Exception is MPLS L3VPN
- Enable interface OSPF process
  > process level
    - network [address] [wildcard] area [area-id]
  > interface level
    - ip ospf [process-id] area [area-id]
  > both are esentially enabling the ospf process
  > like in EIGRP, there is a key distinction between the network statement and what is actually being advertised
    - example, when you issue a /8 in network statement, it doesnt necessarily mean that you are advertising the /8 prefix
    - you are advertising the SUBNET MASK of the INTERFACE in which the OSPF is actually configured on
  
OSPF Network Statement
- useful for ENABLING OSPF on multiple interfaces at the same time
  > wildcard mask does not relate to subnet mask
- Most specific match determines the area
  > network 0.0.0.0 255.255.255.255 area 0
  > network 1.0.0.0 0.255.255.255 area 1
  > network 1.2.0.0 0.0.255.255 area 2
  > network 1.2.3.0 0.0.0.255 area 3
  > network 1.2.3.4 0.0.0.0 area 4
- better to check the area an interface belongs by using
  > show ip ospf interface [brief]


OSPF Interface Statement
- Enables OSPF on the primary address and secondary IP addresses at the same time
  > Secondary advertisement can be disabled
  > not disbaled by default
	> to disable
		conf t
		int gig1.146
			ip ospf 1 area 0 secondaries none
- OSPF stays enabled even if IP address changes
  

OSPF Verification
- Verify OSPF is enabled
  > show ip ospf
		- process number
		- Router ID
		- other global attributes
  > show ip ospf interface [brief]
		- network type
		- cost
		- DR/BDR
		- How many routers am I adjacent with?
- Verify OSPF adjacencies
  > show ip ospf neighbor
  > debug ip ospf adjacency
- Verify OSPF database
  > show ip ospf database [router|network|summary|...]
	

-show ip ospf int brief
  > F/C = Full Adjacencies / Total Neighbors = Full State / 2-WAY State

- show ip ospf neighbor
R8#show ip ospf neighbor 

Neighbor ID     Pri   State           Dead Time   Address         Interface
150.1.10.10       1   FULL/DR         00:00:32    155.1.108.10    GigabitEthernet1/0.108

- 150.1.10.10 = Router ID of the node in LSDB. Note that RID is not a routable address. It is just inherited from the loopback, in this case


-------------------------------------------------------
OSPF on R8 ad R10 only
R8#show run | sec ospf
router ospf 1
 network 0.0.0.0 255.255.255.255 area 0

R10#show run | sec ospf
router ospf 1
 network 155.1.0.0 0.0.255.255 area 0


- show ip route ospf
R8#show ip route ospf
Codes: L - local, C - connected, S - static, R - RIP, M - mobile, B - BGP
       D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area 
       N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
       E1 - OSPF external type 1, E2 - OSPF external type 2
       i - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2
       ia - IS-IS inter area, * - candidate default, U - per-user static route
       o - ODR, P - periodic downloaded static route, H - NHRP, l - LISP
       + - replicated route, % - next hop override

Gateway of last resort is not set

      155.1.0.0/16 is variably subnetted, 7 subnets, 2 masks
O        155.1.10.0/24 
           [110/2] via 155.1.108.10, 00:05:48, GigabitEthernet1/0.108


Configuration
conf t
router ospf 1
  network 155.1.0.0 0.0.255.255 area 0
  auto-cost reference-bandwidth 100000 <----------------change reference BW to 100G, default is 100M
end


R8#show ip ospf database router 150.1.8.8

            OSPF Router with ID (150.1.8.8) (Process ID 1)

                Router Link States (Area 0)

  LS age: 656
  Options: (No TOS-capability, DC)
  LS Type: Router Links
  Link State ID: 150.1.8.8
  Advertising Router: 150.1.8.8
  LS Seq Number: 80000002
  Checksum: 0xCE99
  Length: 72
  Number of Links: 4 <----------------- number of links in OSPF process. count of output in "show ip ospf interface brief"

    Link connected to: a Stub Network
     (Link ID) Network/subnet number: 150.1.8.8
     (Link Data) Network Mask: 255.255.255.255
      Number of MTID metrics: 0
       TOS 0 Metrics: 1

    Link connected to: a Transit Network
     (Link ID) Designated Router address: 155.1.108.10  <---------------------- IP of DR
     (Link Data) Router Interface address: 155.1.108.8
      Number of MTID metrics: 0
       TOS 0 Metrics: 1

    Link connected to: a Stub Network
     (Link ID) Network/subnet number: 155.1.58.0
     (Link Data) Network Mask: 255.255.255.0
      Number of MTID metrics: 0
       TOS 0 Metrics: 1

    Link connected to: a Stub Network
     (Link ID) Network/subnet number: 155.1.8.0
     (Link Data) Network Mask: 255.255.255.0
      Number of MTID metrics: 0
       TOS 0 Metrics: 1



- show ip ospf database
  > LSA1 Router LSA
    - describes how we route to the node in the graph
    - attribute of the links that Node owns
    - originated by all routers in the area
  > LSA2 - Network LSA
    - originated by the Designated Router (there is DR for each broadcast network)
    - describe who the other nodes on the particular segment

R8#show ip ospf database 

            OSPF Router with ID (150.1.8.8) (Process ID 1)

                Router Link States (Area 0)

Link ID         ADV Router      Age         Seq#       Checksum Link count
150.1.8.8       150.1.8.8       511         0x80000002 0x00CE99 4
150.1.10.10     150.1.10.10     515         0x80000002 0x00D725 2

                Net Link States (Area 0)

Link ID         ADV Router      Age         Seq#       Checksum
155.1.108.10    150.1.10.10     515         0x80000001 0x000C1C <------------------ Node 150.1.10.10 is generating the Network LSA. ONLY DRs generate Network LSA 



R8#show ip ospf database network 155.1.108.10

            OSPF Router with ID (150.1.8.8) (Process ID 1)

                Net Link States (Area 0)

  Routing Bit Set on this LSA in topology Base with MTID 0
  LS age: 756
  Options: (No TOS-capability, DC)
  LS Type: Network Links
  Link State ID: 155.1.108.10 (address of Designated Router)
  Advertising Router: 150.1.10.10
  LS Seq Number: 80000002
  Checksum: 0xA1D
  Length: 32
  Network Mask: /24
        Attached Router: 150.1.10.10
        Attached Router: 150.1.8.8


R8#show ip ospf data router 150.1.10.10

            OSPF Router with ID (150.1.8.8) (Process ID 1)

                Router Link States (Area 0)

  LS age: 940
  Options: (No TOS-capability, DC)
  LS Type: Router Links
  Link State ID: 150.1.10.10
  Advertising Router: 150.1.10.10
  LS Seq Number: 80000003
  Checksum: 0xD526
  Length: 48
  Number of Links: 2

    Link connected to: a Transit Network
     (Link ID) Designated Router address: 155.1.108.10
     (Link Data) Router Interface address: 155.1.108.10
      Number of MTID metrics: 0
       TOS 0 Metrics: 1

    Link connected to: a Stub Network
     (Link ID) Network/subnet number: 155.1.10.0
     (Link Data) Network Mask: 255.255.255.0
      Number of MTID metrics: 0
       TOS 0 Metrics: 1

-------------------------------------------------------

Run OSPF on R1, R4, R6 segment

R1 and R6
conf t
int gig1/0.146
	ip ospf 1 area 0
	
R4
conf t
router ospf 1
	network 155.1.146.4 0.0.0.0 area 0


R4#show ip ospf interface brief
Interface    PID   Area            IP Address/Mask    Cost  State Nbrs F/C
Gi1/0.146    1     0               155.1.146.4/24     1     DROTH 2/2


R1#show ip ospf interface br
Interface    PID   Area            IP Address/Mask    Cost  State Nbrs F/C
Gi1/0.146    1     0               155.1.146.1/24     1     BDR   2/2

R1#show ip ospf neighbor

Neighbor ID     Pri   State           Dead Time   Address         Interface
150.1.4.4         1   FULL/DROTHER    00:00:35    155.1.146.4     GigabitEthernet1/0.146
150.1.6.6         1   FULL/DR         00:00:36    155.1.146.6     GigabitEthernet1/0.146
R1#
R1#
R1#show ip ospf database

            OSPF Router with ID (150.1.1.1) (Process ID 1)

                Router Link States (Area 0)

Link ID         ADV Router      Age         Seq#       Checksum Link count
150.1.1.1       150.1.1.1       209         0x80000002 0x00AAEE 1
150.1.4.4       150.1.4.4       179         0x80000002 0x006E1C 1
150.1.6.6       150.1.6.6       210         0x80000002 0x00463A 1

                Net Link States (Area 0)

Link ID         ADV Router      Age         Seq#       Checksum
155.1.146.6     150.1.6.6       179         0x80000002 0x00304F

--------------------------------------------------------------

EXAMPLE
OSPF running on the underlay of the DMVPN

conf t
int gig1/0.100
ip ospf 1 area 0




Designated Router
Backup BR
DR Other

Example:
- On a segment shared by 5 routers
  > 1 DR
		- Adjacent with the other 4
	> 1 BDR
		- Adjacent with the other 4
	> 3 DR Other
		- DR Other router will be ADJACENT with BR and BDR only
		- DR Other router will form NEIGHBOR relationship with the rest of the routers
- OSPF runs as NETWORK TYPE BROADCAST by default on a shared LAN segment (NOT ADVISABLE to run as default on P2P links)
	> command below to change the default behaviour to P2P
		conf t
		int <INT_NAME>
			ip ospf network point-to-point
- DR's role is to shorten the Shortest Path Tree calculation
	> think of this as a switch with a star topology
	> You dont want to make a calculation 5 times (5 routers on the segment)
	> Calculation will just be based on the DR's perspective, since the rest of the router on the segment is connected to the DR anyway
	> This is to lessen work on the CPE. Not really needed on today's network as CPUs are now powerful
	> This is an issue on the old Routers

- On show ip ospf database
	> Adv Router is not-reachable in topology Base with MTID 0
		- meaning that routing bit is not set on the LSA
		- missing router information will be deleted after 60 mins if it stays down
		- efficiency mechanism so local router will know that "missing" router when it adds itself back into the topology
			> when missing router adds itself back, local router will check if the LSA contents
			> when LSA content did not change, sequence number will be updated. LSA age will be updated
			> local router WILL NOT HAVE TO request for the information for that missing router anymore
			
	
	
R1#show ip ospf int br
Interface    PID   Area            IP Address/Mask    Cost  State Nbrs F/C
Gi1/0.100    1     0               169.254.100.1/24   1     DROTH 2/4
Gi1/0.146    1     0               155.1.146.1/24     1     BDR   2/2

R2#show ip ospf int br
Interface    PID   Area            IP Address/Mask    Cost  State Nbrs F/C
Gi1/0.100    1     0               169.254.100.2/24   1     DROTH 2/4

R3#show ip ospf int br
Interface    PID   Area            IP Address/Mask    Cost  State Nbrs F/C
Gi1/0.100    1     0               169.254.100.3/24   1     DROTH 2/4

R4#show ip ospf int brief 
Interface    PID   Area            IP Address/Mask    Cost  State Nbrs F/C
Gi1/0.100    1     0               169.254.100.4/24   1     BDR   4/4
Gi1/0.146    1     0               155.1.146.4/24     1     DROTH 2/2

R5#show ip ospf interface br
Interface    PID   Area            IP Address/Mask    Cost  State Nbrs F/C
Gi1/0.100    1     0               169.254.100.5/24   1     DR    4/4


R1#show ip ospf neighbor 

Neighbor ID     Pri   State           Dead Time   Address         Interface
150.1.2.2         1   2WAY/DROTHER    00:00:36    169.254.100.2   GigabitEthernet1/0.100
150.1.3.3         1   2WAY/DROTHER    00:00:33    169.254.100.3   GigabitEthernet1/0.100
150.1.4.4         1   FULL/BDR        00:00:33    169.254.100.4   GigabitEthernet1/0.100
150.1.5.5         1   FULL/DR         00:00:36    169.254.100.5   GigabitEthernet1/0.100
150.1.4.4         1   FULL/DROTHER    00:00:39    155.1.146.4     GigabitEthernet1/0.146
150.1.6.6         1   FULL/DR         00:00:38    155.1.146.6     GigabitEthernet1/0.146

R2#show ip ospf neighbor 

Neighbor ID     Pri   State           Dead Time   Address         Interface
150.1.1.1         1   2WAY/DROTHER    00:00:36    169.254.100.1   GigabitEthernet1/0.100
150.1.3.3         1   2WAY/DROTHER    00:00:33    169.254.100.3   GigabitEthernet1/0.100
150.1.4.4         1   FULL/BDR        00:00:33    169.254.100.4   GigabitEthernet1/0.100
150.1.5.5         1   FULL/DR         00:00:36    169.254.100.5   GigabitEthernet1/0.100

R3#show ip ospf neighbor 

Neighbor ID     Pri   State           Dead Time   Address         Interface
150.1.1.1         1   2WAY/DROTHER    00:00:34    169.254.100.1   GigabitEthernet1/0.100
150.1.2.2         1   2WAY/DROTHER    00:00:35    169.254.100.2   GigabitEthernet1/0.100
150.1.4.4         1   FULL/BDR        00:00:30    169.254.100.4   GigabitEthernet1/0.100
150.1.5.5         1   FULL/DR         00:00:34    169.254.100.5   GigabitEthernet1/0.100

R4#show ip ospf neighbor 

Neighbor ID     Pri   State           Dead Time   Address         Interface
150.1.1.1         1   FULL/DROTHER    00:00:38    169.254.100.1   GigabitEthernet1/0.100
150.1.2.2         1   FULL/DROTHER    00:00:39    169.254.100.2   GigabitEthernet1/0.100
150.1.3.3         1   FULL/DROTHER    00:00:35    169.254.100.3   GigabitEthernet1/0.100
150.1.5.5         1   FULL/DR         00:00:39    169.254.100.5   GigabitEthernet1/0.100
150.1.1.1         1   FULL/BDR        00:00:35    155.1.146.1     GigabitEthernet1/0.146
150.1.6.6         1   FULL/DR         00:00:31    155.1.146.6     GigabitEthernet1/0.146

R5#show ip ospf neighbor 

Neighbor ID     Pri   State           Dead Time   Address         Interface
150.1.1.1         1   FULL/DROTHER    00:00:39    169.254.100.1   GigabitEthernet1/0.100
150.1.2.2         1   FULL/DROTHER    00:00:39    169.254.100.2   GigabitEthernet1/0.100
150.1.3.3         1   FULL/DROTHER    00:00:35    169.254.100.3   GigabitEthernet1/0.100
150.1.4.4         1   FULL/BDR        00:00:35    169.254.100.4   GigabitEthernet1/0.100

======================================================================
Troubleshooting OSPF Adjacencies

Understanding OSPF State Machine
Interpreting show commands
Interpreting debug commands


Where problem arise?
- Transport Problems
- Attribute negotiation problems

Useful Commands
- show ip ospf neighbor
	> better to also check the database. Adjacency might form between neighbors but no routes will be installed
		- this happens if the ospf attribute/s are mismatched
- show ip ospf database
- show ip ospf database router [ROUTER_ID]
	> Check for "Adv Router is not-reachable in topology"
		- means routing bit is NOT SET. Router ID is unreachable
- debug ip ospf adj
- debug ip packet
	> use with caution
	
Syslog Messages
- Duplicate router ID
- FLOOD_WAR
	> One router is advertising a route into the OSPF network
	> Another is withdrawing that route
	> normally seen because 2 or more routers share a Router ID
- Flapping between EXSTART and DOWN
	> remember attributes are negotiated on EXSTART
		- area, stub flags, mtu, etc
		

Normal OSPF Adjacency State Machine Order
- Down
	> No hellos received from neighbor
- Attempt
	> Unicast hello packet has been sent to neighbot, but no hellos has been received back
	> only used for manually configured NBMA neighbors
- Init
	> I have received a hello packet from a neighbor, but they have not acknowledged a hello from me
	> Stucke here? probably a transport problem. check filtering
- 2-Way
	> Stop here for DROthers
	> If you dont get to 2-way, there is a transport problem
		- DMVPN wrong mapping
		- VLAN ACL dropping OSPF
		- Layer 1 issues
		- etc
- ExStart
	> Stucke here? probably attribute issue
- Exchange
	> Stucke here? probably attribute issue
- Loading
- Full

- Network Type P2P
interface GigabitEthernet1/0.108
 encapsulation dot1Q 108
 ip address 155.1.108.8 255.255.255.0
 ip ospf network point-to-point



OSPF Adjacency Attributes
- Unique OSPF Adj Attributes
	> Router-ID
	> Interface IP Address
- Common OSPF Adjacency Attributes
	> Interface Area-ID
	> Hello Interval and Dead Interval
	> Interface network address
	> Interface MTU
		- best practice is NOT TO IGNORE MTU checks
	> Network Type
		- defaults to Broadcast
		- p2p
				interface GigabitEthernet1/0.108
					ip ospf network point-to-point
		- if there is a network type mismatch
			> database will show the issue. routing bit is NOT SET
			> one router is trying to recurse to LSA type 2. but the other router doesnt have LSA 2 because it is on P2P
			> on show ip ospf neighbor, it looks like they form an adjacency
				- it will show that one has a DR/BDR, the other has "-"
		- make sure that network types match
			> P2P and P2Multipoint SHOULD work together since they both dont use LSA type 2
				- BUT TIMERS SHOULD MATCH, because different network types have different default times
				- P2P has hello 10. Dead 40
				- P2Multipoint has hello 30. dead 120
			
			Example:
			R8
			interface GigabitEthernet1/0.108
			 encapsulation dot1Q 108
			 ip address 155.1.108.8 255.255.255.0
			 ip ospf network point-to-multipoint
			 ip ospf hello-interval 10
			 ipv6 address 2001:155:1:108::8/64
			end
				
			R10
			interface GigabitEthernet1/0.108
			 encapsulation dot1Q 108
			 ip address 155.1.108.10 255.255.255.0
			 ip ospf network point-to-point
			 ipv6 address 2001:155:1:108::10/64
			end
	
	> Authentication
	> Stub Flags
	> Other optional capabilities
	
	
----------------------
Example

DMVPN
OSPF on tunnel 0

R5#show ip ospf int tun0
Tunnel0 is administratively down, line protocol is down 
  Internet Address 155.1.0.5/24, Area 0, Attached via Network Statement
  Process ID 1, Router ID 150.1.5.5, Network Type POINT_TO_POINT, Cost: 1000
  Topology-MTID    Cost    Disabled    Shutdown      Topology Name
        0           1000      no          no            Base
  Transmit Delay is 1 sec, State DOWN
  Timer intervals configured, Hello 10, Dead 40, Wait 40, Retransmit 5
    oob-resync timeout 40
R5#


- GRE Tunnel is P2P on OSPF point of view
- This is why the adjacencies will flap continuously. P2P only allows a single adjacency on an interface
- P2Multipoint will solve the problem
	> Broadcast or Non-broadcast

======================================================================
OSPF Areas and LSAs


- Scaling OSPF with Areas
- OSPF LSA Types
- OSPF Path Selection
	> Intra-Area
	> Inter-Area
	> External

Overview
- Areas add heirarchy and scalability to OSPF
- An area defines a flooding domain
	> All devices in the area agree on the topology
	> Changes inside the area require LSA flooding and full SPF algo run
- Routing between areas hides topology details
	> Inter-area routing is similar to distance vector
	> Changes outside the area dont always require LSA flooding or SPF run
	> Limits impacts on router resources

OSPF Two-Level Heirarchy
- Backbone Area
	> Area 0 (0.0.0.0)
	> Used to summarize topology (NOT TO BE CONFUSED WITH NLRI SUMMARIZATION) information between other areas
		- LSA type 3. Network summary
	> Traffic from one area to another must pass through area 0
	> Must be contiguous
		- all other areas are connected to area 0
		- area 0 is in the middle. other areas are outside
- Non-Backbone Area
	> All other areas except Area 0. Range is 1 to 2^32 (0.0.0.1 - 255.255.255.255)
	> Must use connections to area 0 to reach other areas


OSPF Router Types
- Backbone Routers
	> At least one link in Area 0
- Internal Routers
	> All links in one non-backbone area
- Area Border Router (ABR)
	> Links in both area 0 and in non-backbone area(s)
	> Used to summarize information between area 0 and non-backbone area
- Autonomous System Boundary Router (ASBR)
	> At least one link in OSPF domain
	> At least one link outside OSPF domain
		- EIGRP, IS-IS, BGP, etc.
	> Used to redistribute information to/from other routing domains and OSPF


OSPF LSA Types
- With different router types in the OSPF domain, different types of advertisements are required
	> eg. DR, ABR, ASBR, etc
- Different LSA formats used to represent this information
	> Format is defined by type code
	> Type 1, type 2, etc
- LSA Types are 
	> Type 1 - Router LSA
		- Generated by every router in the OSPF domain
		- Not flooded outside the area they originate in
		- Describes its directly connected links
			> What are my link costs
			> Who are my neighbors
		- Used to build the grapf for intra-area SPF
    - P2P
    - Point to Multipoint (Hub has different Link count than spokes)
	> Type 2 - Network LSA
		- Generated by Designated Router (DR) on broadcast and non-broadcast network types
		- Not flooded outside the area they originate in
    - Describes who is adjacent with the DR
      > what is my link cost to the DR
      > Implies my link cost to all others adjacent to that DR
    - Used to reduce redundant information in the database
      > (n*(n-1)/2) and flooding scalability issue
    - Used by Broadcast and Non-Broadcast Network Types
    - NOT used by P2P, P2Multipoint, P2Multipoint Non-Broadcast
	> Type 3 - Network Summary LSA
    - Generated by ABR
    - Flooded from area 0 into non-backbone areas and vice-versa
    - Describes ABRs reachability to link in other areas
      > includes cost, but hides ABR's actual path to destination
    - SPF not run for ABR advertised routes
      > ABR can reach link A via SPT in cost X
      > I can reach ABR via SPT in cost Y
      > Implies I can reach link A via SPT in cost X+Y
    - This is why inter-area routing is like distance vector
	> Type 4 - ASBR Summary LSA
    - Generated by ABR
    - Flooded from area 0 into non-backbone areas and vice-versa
    - Describes ABR's reachability into ASBRs in other areas
      > includes cost, but hides ABR's actual path to destination
    - SPF not run for ABR advertised routes
      > ABR can reach ASBR via SPT in cost X
      > I can reach ABR via SPT in cost Y
      > Implies I can reach ASBR via SPT in cost X+Y
    - Inter-area external routing is also like distance vector
	> Type 5 - External LSA
    - Generated by ASBR
    - Flooded to all non-stub areas (all OSPF devices except for stub areas)
    - Describes routes ASBR is redistributing
      > Metric
      > Metric Type (notes below)
        - Type 1 = E1
        - Type 2 = E2 (default)
      > Forward Address (functions like BGP route reflector)
        - Who should I route towards to reach the link
        - Usually the ASBR itself, but could be someone else in some designs
      > Route Tag
	> Type 6 - Multicast LSA
		- MOSPF - not implemented by most vendors (abandoned protocol)
	> Type 7 - NSSA External LSA (Not So Stubby Area)
    - Generated by ASBR inside a Not-So-Stubby-Area
	> Type 8, 9, 10 - Opaque LSA
		- Used for extensibility
		- eg. MPLS Traffic Engineering


LSAs and Route Types
- LSAs are grouped together by 3 route types
- Intra-Area Routes (O)
	> LSA Types 1 and 2
- Inter-Area Routes (O IA)
	> LSA Types 3 and 4
- External Routes
	> E1/E2
		- LSA Type 5
	> N1/N2
		- LSA Type 7
    
OSPF External Type 1 vs Type 2
- External route type controls how metric for external link is calculated
- Type 1 (E1)
  > Take the cost the ASBR reports in plus the cost to the ASBR
- Type 2 (E2)
  > Take just the cost the ASBR reports in
  > If there is a tie, then take the cost to the ASBR as well
- Type 1 is preferred over Type 2
- Hot potato (Route traffic as quickly as possible) vs Cold Potato (most accurate route) routing


OSPF External Route Calculation
- Performs like distance vec
  > ASBR can reach link A in cost X
  > I can reach ASBR via SPT in cost Y
  > I can reach link A via SPT in cost (X+Y)
- Inter-area externals
  > ASBR can reach link A in cost X
  > ABR can reach ASBR via SPT in cost Y
  > I can reach ABR via SPT in cost Z
  > I can reach link A via SPT in cost (X+Y+Z)


show ip route [IP ADDRESS]
  > check for the "forward metric". that is the metric endorsed by ABR and ASBR
  > the "metric" is the metric to the ABR
show ip ospf database router 150.1.8.8
  > check if the IP is on same area
show ip ospf database asbr-summary 150.1.8.8
  > check if there is a router who has a summary to 150.1.8.8
show ip ospf database border-router
  > check metric to ABR


======================================================================
OSPF Media Dependencies & Network Types


DR/BDR Election Process
OSPF Next Hop Processing
OSPF Network Type Design Issues


- OSPF's behavior changes depending on what type of media it is configured on
  >ie. Ethernet vs Frame Relay vs PPP
- OSPF defines different "network types" to deal with different media characteristics
- OSPF network types control:
  > How are hellos and updates sent
  > Who forms adjacency?
  > How is the next-hop calculated?

OSPF Network Types
- Broadcast
- Non-broadcast
- Point to Point
- Point to Multipoint
- Point to Multipoint Non-Broadcast
- Loopback

OSPF Network Types and Forming Adjacencies
- OSPF network type does not need to match to form adjacency
  > But they do need to be compatible
    - ie. P2P and Point-to-Multipoint will form adjacency (no LSA Type 2)
    - (Broadcast and Non-Broadcast) vs All other types
    - Usage of Type 2 LSA will determine if network types are compatible
  > Other attributes must still match
    - ie. timers

OSPF Network Broadcast
- Default on multi-access broadcast media
  > Ethernet
  > Token Ring
  > FDDI
- Sends hellos and updates as MULTICAST
  > 224.0.0.5 (All SPF Routers)
  > 224.0.0.6 (All DR Routers)
- Used DR and BDR
  > Used Type 2 LSA

OSPF Network Non-Broadcast
- Default on multipoint NBMA medias
  > Frame Relay and ATM
- Sends hellos and updates as UNICAST
  > Manually defined addresses with neighbor command
- Used DR and BDR
  > Used Type 2 LSA


HOW THE DR AND BDR WORK
- Designated Router (DR)
  > Forms adjacency with all routers on the link
  > Listens for LSUs (224.0.0.6)
  > Re-floods LSUs back to the segment (224.0.0.5)
    - like a route reflector
  > Does not modify next-hop value
- Backup Designated Router
  > Used for redundancy of DR
  > Does not re-flood LSUs
  > Listens for LSAs from DR. If DR goes down, BDR will promote itself as the DR


HOW DROTHERS WORK
- DROther
  > All other routers on the link
    - Not the DR and BDR
  > Form FULL adjacency with DR and BDR
  > Stop at 2-Way adjacency with each other


DR/BDR ELECTION
- Election is done once routers are in 2-way state
- Election based on interface priority and Router-ID
	> Priority
    - 0-255
    - Higher is better
    - 0 = never
  > Router-ID
    - Highest loopback / interface IP
    - can be statically set
    - higher is better
- Uses WAIT timer to stop pre-emption of current DR/BDR
  > Unlink IS-IS's Designated Intermediate System (DIS)
  > DIS = DR in OSPF
- Election is done on 224.0.0.5 (All SPF Routers)
- by default, the router who comes up on the segment first elects itself as the BDR
  > even though priority is lower compared to other routers
  > problem is when that router is a spoke on a hub and spoke topology. it wont have reachability to other routers on L2 perspective
    - this router will promote itself as the DR
  > when another router comes up (with higher priority), it will skip WAIT timer and elect itself as the BDR and ack the first router as the DR
  

OSPF Network Point-to-Point
- Default on p2p media
  > HDLC, PPP, GRE
- Sends hellos as multicast
  > 224.0.0.5
- No BR/BDR Election
- Supports only TWO neighbors on the link

OSPF Point-to-Multipoint
- Treats network as a collection of P2P links
- Sends hellos as multicast
  > 224.0.0.5
- No BR/BDR Election
- Special next-hop processing
- Usually the best design option for partial mesh NMBA networks
  > DMVPN, Frame Relay Partial Mesh
  
  
OSPF Point-to-Multipoint Non-Broadcast
- Same as Point-to-Multipoint, but send hellos as unicast
  > Manually defined addresses with neighbor command
  > Allows for per-VC OSPF cost over NBMA
- No BR/BDR Election
- Special next-hop processing

OSPF Network Loopback
- Special case for Loopback and Looped-back interfaces (hardware)
- Advertises link as /32 stub host route
- ip ospf network point-to-point used to disable this behavior

======================================================================
Configuring OSPF Network Types

- Election is invoked once ADJACENCY STATE MACHINE reaches or beyond 2-WAY state

- Note current values for network's DR and BDR. Used for comparison later
- Elect BDR first. If no DR is detected based from hellos, the BDR will promote itself as the DR.
- If there are 2 or more BDRs, highest router priority is declared to be BDR
- In case of a tie, the one having the highest Router ID is chosen
- See RFC 2328 for the rest
https://tools.ietf.org/html/rfc2328

WAIT Timer = Dead Timer
- Router will wait for WAIT_TIMER for any hellos saying he is the designated router/starting election
- If so, local router will accept that neighboring router as the DR
- No DR preemption happens

- NOTE: Routers will remember the DR once the OSPF process runs

======================================================================
OSPF Virtual Links

- OSPF Discontiguoug Areas
- OSPF Virtual Links
- Path Selection with OSPF Virtual Links

OSPF Inter-Area Routing Review
- Relies on Network Summary LSA
- LSA Type 3 - Network Summary LSA
	> Generated by ABRs
	> Flooded from area 0 into non-transit area and vice-versa
	> Describes ABR's reachability to links in other areas
	> Remember: ABR has a link to area 0
		- If a router does not have a link to area 0, it wont become an ABR even if it has links to other areas
		- No LSA 3 can be seen in the database

OSPF Discontiguous Area Problems
- SPF not run to each an ABR's advertised Inter-Area routes
	> Use the Intra-Area SPT to the ABR
	> Add the ABR's cost to my SPT cost

What if the ABR isn't reachable via an SPT?
- Certain states cause ABRs to be unreachable
- These states are called "discontiguous" areas or discontiguous area 0

Repairing Discontiguous Areas
- Broken Area designs are fixed yb adding new area 0 links and adjacencies
	> Links could be either physical or virtual
	> eg. GRE tunnel
- OSPF virtual Links are a form of virtual area 0 adjacencies
	> form a P2P area 0 adjacency (multihop)
- Control Plane point of view, no difference between GRE and Virtual Link
- Data Plane pov, 
	> GRE is not efficient
	> GRE is mostly software switched
	> Virtual Link doesnt add overhead. No another interface in the routing table. VLs add an interface in the database graph

OSPF Virtual Links
- How OSPF Virtual Links work
	> used to form multi-hop unicast area 0 adjancency
	> Follows the already built SPT between ABRs to heal the database


OSPF Virtual Links Caveats
- Endpoints must be reachable via a NORMAL area
	> ie. not a stub, NSSA, etc
- Transit area must not have filtering applied
	> ie. LSA 3 filters, distribute lists, etc
- Inherits cost from SPT cost between endpoints
	> Cost must be below 65535 (0xFFFF) - 2 bytes
	> cost of an individual link cannot be more than 65535
- Runs as a demand circuit
	> Errors in config could be hidden until flooding occurs
	> DOES NOT SEND periodic hellos
	> example: configure authentication on one side of the virtual link only. network will work temporarily
- Rule of Thumb
	> For any changes in the OSPF network, flap the virtual link
	> clear ip ospf PROCESS
	> this is to make sure that it comes back
	
----------------------------------------------
Configuring Virtual Link
Scenario
- R7 R9 Gig1.79 in area 3
- R1 R4 R6 Gig1.146 in area 2
- R6 R7 Gig1.67 in area 2
- R1 R2 R3 R4 R5 DMVPN tunnel0 and loopback0 in area 0
- Configure Virtual Link between R7 and R1 (and/or to R4 for traffic engineering)

R1
conf t 
	router ospf 1
		area 2 virtual-link 150.1.7.7 				! 150.1.7.7 is the router ID. we are creating a VL to the NODE in the graph

R7
conf t
	router ospf 1
		area 2 virtual-link 150.1.1.1					! going to R1's router ID


R7#show ip ospf neighbor 

Neighbor ID     Pri   State           Dead Time   Address         Interface
150.1.1.1         0   FULL/  -        00:00:16    155.1.146.1     OSPF_VL0
150.1.6.6         1   FULL/BDR        00:00:38    155.1.67.6      GigabitEthernet1/0.67
150.1.9.9         1   FULL/DR         00:00:35    155.1.79.9      GigabitEthernet1/0.79

R1#show ip ospf neighbor 

Neighbor ID     Pri   State           Dead Time   Address         Interface
150.1.7.7         0   FULL/  -        00:00:00    155.1.67.7      OSPF_VL0
150.1.5.5         0   FULL/  -        00:01:43    155.1.0.5       Tunnel0
150.1.4.4         1   FULL/DROTHER    00:00:38    155.1.146.4     GigabitEthernet1/0.146
150.1.6.6         1   FULL/DR         00:00:32    155.1.146.6     GigabitEthernet1/0.146


- DNA = Does Not Age. (Virtual Link)
- When LSA age increments past 30 mins. Originating router will reflood its LSA
	> With DNA flag set, flooding every 30 mins does NOT happen
R5#show ip ospf database 

            OSPF Router with ID (150.1.5.5) (Process ID 1)

                Router Link States (Area 0)

Link ID         ADV Router      Age         Seq#       Checksum Link count
150.1.1.1       150.1.1.1       21          0x80000006 0x00236C 4
150.1.2.2       150.1.2.2       18          0x80000003 0x00066E 3
150.1.3.3       150.1.3.3       16          0x80000003 0x003339 3
150.1.4.4       150.1.4.4       14          0x80000004 0x006101 3
150.1.5.5       150.1.5.5       10          0x80000005 0x00AC0A 6
150.1.7.7       150.1.7.7       2     (DNA) 0x80000002 0x00EA77 1

                Summary Net Link States (Area 0)

Link ID         ADV Router      Age         Seq#       Checksum
150.1.6.6       150.1.1.1       1051        0x80000001 0x000DF0
150.1.6.6       150.1.4.4       1038        0x80000001 0x00E512
150.1.6.6       150.1.7.7       7     (DNA) 0x80000001 0x00BE33
150.1.7.7       150.1.7.7       7     (DNA) 0x80000001 0x009F51
150.1.9.9       150.1.7.7       7     (DNA) 0x80000001 0x007F6C
155.1.7.0       150.1.7.7       7     (DNA) 0x80000001 0x00A44E
155.1.9.0       150.1.7.7       7     (DNA) 0x80000001 0x009857
155.1.37.0      150.1.7.7       7     (DNA) 0x80000001 0x00597B
155.1.67.0      150.1.1.1       1051        0x80000001 0x00665B
155.1.67.0      150.1.4.4       1038        0x80000001 0x003F7C
155.1.67.0      150.1.7.7       7     (DNA) 0x80000001 0x000EA8
155.1.79.0      150.1.7.7       7     (DNA) 0x80000001 0x008921
155.1.146.0     150.1.1.1       1051        0x80000001 0x00F37F
155.1.146.0     150.1.4.4       1038        0x80000001 0x00CCA0
155.1.146.0     150.1.7.7       7     (DNA) 0x80000001 0x00AFB6
R5#


R7#show ip ospf interface 
OSPF_VL0 is up, line protocol is up 
  Internet Address 155.1.67.7/24, Area 0, Attached via Not Attached
  Process ID 1, Router ID 150.1.7.7, Network Type VIRTUAL_LINK, Cost: 2 <------------------------------------------!!!!! Cost of 1 (SPT) to 150.1.1.1 
  Topology-MTID    Cost    Disabled    Shutdown      Topology Name
        0           2         no          no            Base
  Configured as demand circuit <------------------------------------------!!!!!
  Run as demand circuit
  DoNotAge LSA allowed <------------------------------------------!!!!!
  Transmit Delay is 1 sec, State POINT_TO_POINT
  Timer intervals configured, Hello 10, Dead 40, Wait 40, Retransmit 5
    oob-resync timeout 40
    Hello due in 00:00:07
  Supports Link-local Signaling (LLS)
  Cisco NSF helper support enabled
  IETF NSF helper support enabled
  Index 1/6, flood queue length 0
  Next 0x0(0)/0x0(0)
  Last flood scan length is 1, maximum is 1
  Last flood scan time is 0 msec, maximum is 0 msec
  Neighbor Count is 1, Adjacent neighbor count is 1 
    Adjacent with neighbor 150.1.1.1  (Hello suppressed) <------------------------------------------!!!!!
  Suppress hello for 1 neighbor(s) <------------------------------------------!!!!!
- SNIPPED - 

R7#show ip ospf database router self-originate 

            OSPF Router with ID (150.1.7.7) (Process ID 1)

                Router Link States (Area 0) <------------------------------------------!!!!!

  LS age: 1337
  Options: (No TOS-capability, DC)
  LS Type: Router Links
  Link State ID: 150.1.7.7
  Advertising Router: 150.1.7.7
  LS Seq Number: 80000002
  Checksum: 0xEA77
  Length: 36
  Area Border Router
  Number of Links: 1

    Link connected to: a Virtual Link
     (Link ID) Neighboring Router ID: 150.1.1.1
     (Link Data) Router Interface address: 155.1.67.7
      Number of MTID metrics: 0
       TOS 0 Metrics: 2 <------------------------------------------!!!!! based on area 2 spt cost


          
                Router Link States (Area 2)

  LS age: 1337
  Options: (No TOS-capability, DC)
  LS Type: Router Links
  Link State ID: 150.1.7.7
  Advertising Router: 150.1.7.7
  LS Seq Number: 80000004
  Checksum: 0x769B
  Length: 36
  Area Border Router
  Virtual Link Endpoint
  Number of Links: 1

    Link connected to: a Transit Network
     (Link ID) Designated Router address: 155.1.67.7
     (Link Data) Router Interface address: 155.1.67.7
      Number of MTID metrics: 0
       TOS 0 Metrics: 1

- SNIPPED -


!! Without Virtual Link
R9#show ip ospf database 

            OSPF Router with ID (150.1.9.9) (Process ID 1)

                Router Link States (Area 3)

Link ID         ADV Router      Age         Seq#       Checksum Link count
150.1.7.7       150.1.7.7       1289        0x80000001 0x008F32 4
150.1.9.9       150.1.9.9       1288        0x80000002 0x008AF8 3

                Net Link States (Area 3)

Link ID         ADV Router      Age         Seq#       Checksum
155.1.79.9      150.1.9.9       1288        0x80000001 0x003517
R9#
R9#
R9#


!! With Virtual Link
! R7 is now an ABR
R9#show ip ospf database 

            OSPF Router with ID (150.1.9.9) (Process ID 1)

                Router Link States (Area 3)

Link ID         ADV Router      Age         Seq#       Checksum Link count
150.1.7.7       150.1.7.7       1656        0x80000002 0x00902F 4
150.1.9.9       150.1.9.9       1181        0x80000003 0x0088F9 3

                Net Link States (Area 3)

Link ID         ADV Router      Age         Seq#       Checksum
155.1.79.9      150.1.9.9       1181        0x80000002 0x003318

                Summary Net Link States (Area 3)

Link ID         ADV Router      Age         Seq#       Checksum
150.1.1.1       150.1.7.7       876         0x80000001 0x0032C8
150.1.2.2       150.1.7.7       876         0x80000001 0x00849C
150.1.3.3       150.1.7.7       866         0x80000001 0x006FAF
150.1.4.4       150.1.7.7       861         0x80000002 0x00F003
150.1.5.5       150.1.7.7       866         0x80000001 0x0012F4
150.1.6.6       150.1.7.7       1656        0x80000001 0x00BE33
155.1.0.1       150.1.7.7       1646        0x80000001 0x00F106
155.1.0.2       150.1.7.7       1646        0x80000001 0x004FCF
155.1.0.3       150.1.7.7       1646        0x80000001 0x0045D8
155.1.0.4       150.1.7.7       861         0x80000006 0x00C926
155.1.0.5       150.1.7.7       1646        0x80000001 0x00FD0A
155.1.67.0      150.1.7.7       1656        0x80000001 0x000EA8
155.1.146.0     150.1.7.7       1656        0x80000001 0x00AFB6
R9#

----------------------------------------------

======================================================================
OSPF Stub Areas

- Scaling OSPF with Stub Areas
- OSPF Stub Area Variations
- Type 7 LSA


Scalability
- Function of two variables
- How complex is the topology graph
	> how many routers are in the area
	> large flooding domain means lots of SPF runs
- How much reachability information is there?
	> how many routers are being advertised
	> large routing tables means it takes longer to flood


Topology vs NLRI Summarization
- Topology summarization achieved through OSPF Areas
	> Hide the details of how the graph looks in other areas
	> Only run SPF for intra-area destinations
	> Areas don't hide reachability information, though
- NLRI Summarization reduces the number of routes
	> Take multiple longer match prefixes and combine them into smaller shorter matches

OSPF NLRI Summarization
- 2 Ways
	> Per-prefix summarization
		- ie. two routes 100.0.0.0/16 and 100.1.0.0/16 becomes onerouter 100.0.0./15
	> Per- LSA Sumarization
		- ie. remove all inter-area routes and replace them with the shortest match possible, a default route
		- this is what STUB AREAS do


HOW OSPF Stub Areas Work
- Filtering is enforced at common transit point of the OSPF topology
	> ie. the ABR
- ABR controls which LSAs enter the area
	> Type 3, 4, and/or 5 are filtered depending on the stub type
- Reachbility information removed is then replaced with a default route
	> still allows reachability to removed routes (in most cases)
- All routers in the area MUST agree on the stub flag
	> Part of adjacency negotiation


OSPF Stub Area Types
- Four stub area types control which routes (LSAs) can enter the areae


7:45










======================================================================
Configuring OSPF Stub Areas
======================================================================
Traffic Engineering with OSPF Stub Areas
======================================================================
Configuring OSPF Not So Stubby Areas (NSSA)
======================================================================
Controlling NSSA Redistribution
======================================================================
Default Routing with OSPF NSSA
======================================================================
OSPF NSSA Translator Election & Forwarding Address

======================================================================
OSPF Path Selection

======================================================================
OSPF Authentication

======================================================================
OSPF Authentication Enhancements

======================================================================
OSPF Summarization Overview

======================================================================
Configuring OSPF Summarization
======================================================================
OSPF Route Filtering
======================================================================
Sample
---------------------------------------------------------------
gs89e01#show ospf interface brief

* Indicates MADJ interface, (P) Indicates fast detect hold down state

Interfaces for OSPF 10

Interface          PID   Area            IP Address/Mask    Cost  State Nbrs F/C
Lo1                10    0               166.105.224.54/32  1     LOOP  0/0
Hu0/0/0/0          10    0               10.0.1.93/30       4021  P2P   1/1
Hu0/7/0/0          10    0               10.0.1.89/30       5     P2P   1/1

gs89e01#show ospf neighbor

* Indicates MADJ interface
# Indicates Neighbor awaiting BFD session up

Neighbors for OSPF 10

Neighbor ID     Pri   State           Dead Time   Address         Interface
166.105.224.133 128   FULL/  -        00:00:38    10.0.1.94       HundredGigE0/0/0/0    Neighbor is up for 1w6d <------------ shortest path to reach the NODE 166.105.224.133, NOT THE ROUTE 166.105.224.133
166.105.224.127 1     FULL/  -        00:00:39    10.0.1.90       HundredGigE0/7/0/0    Neighbor is up for 26w6d

Total neighbor count: 2


gs89e01#show route ospf <------------------output below is snipped

O    10.0.0.0/30 [110/16856] via 10.0.1.94, 1w5d, HundredGigE0/0/0/0 <--------------------- 110 = Admin Distance; Cost = 16856; O = OSPF same area
-snipped-

gs89e01#show ospf database <------------------output below is snipped


            OSPF Router with ID (166.105.224.54) (Process ID 10)

		Router Link States (Area 0) <-----------------------------LSA1 Router LSA

Link ID         ADV Router      Age         Seq#       Checksum Link count
159.24.196.45   159.24.196.45   951         0x80016837 0x0019a9 5
159.24.196.46   159.24.196.46   1169        0x80008395 0x00f026 5
159.24.196.49   159.24.196.49   774         0x8001c18f 0x000cec 5
159.24.196.50   159.24.196.50   251         0x800049ed 0x0067bd 5
159.24.196.51   159.24.196.51   475         0x8001c729 0x004a2d 5
159.24.196.52   159.24.196.52   199         0x8001c1c5 0x00038e 5
159.24.196.53   159.24.196.53   337         0x8001c01e 0x00c8e5 5
166.105.224.133 166.105.224.133 1869        0x80010afa 0x00cc91 39
-snipped-

		Net Link States (Area 0) <-----------------------------LSA2 Network LSA

Link ID         ADV Router      Age         Seq#       Checksum
10.0.1.190      166.61.1.76     617         0x80000652 0x00563e
10.0.5.73       166.105.224.40  2428        0x800006c6 0x003f7a
10.0.7.166      166.105.248.8   412         0x80004d5d 0x008029
10.0.8.178      166.105.248.6   505         0x80003ad4 0x00231b
10.0.10.98      166.105.224.51  2214        0x80004de4 0x009a8f
10.0.10.193     166.61.0.168    621         0x80000581 0x005114
10.0.10.197     166.61.0.168    2358        0x800023dc 0x0004c0
10.0.10.201     166.61.0.168    843         0x80000d17 0x00e7d4
10.0.10.206     166.61.0.235    368         0x8000014c 0x00924f
10.0.11.33      166.105.241.65  838         0x800002e4 0x007d1b
-snipped-

gs89e01#show ospf database router 166.105.224.133


            OSPF Router with ID (166.105.224.54) (Process ID 10)

		Router Link States (Area 0)

  Routing Bit Set on this LSA
  LS age: 244
  Options: (No TOS-capability, DC)
  LS Type: Router Links
  Link State ID: 166.105.224.133
  Advertising Router: 166.105.224.133
  LS Seq Number: 80010afb
  Checksum: 0xca92
  Length: 492
  AS Boundary Router
   Number of Links: 39 <------------------- Number of links/interfaces on the router running OSPF

    Link connected to: another Router (point-to-point)
     (Link ID) Neighboring Router ID: 166.105.224.59
     (Link Data) Router Interface address: 10.0.21.138
      Number of TOS metrics: 0
       TOS 0 Metrics: 5

    Link connected to: a Stub Network
     (Link ID) Network/subnet number: 10.0.21.136
     (Link Data) Network Mask: 255.255.255.252
      Number of TOS metrics: 0
       TOS 0 Metrics: 5

    Link connected to: another Router (point-to-point)
     (Link ID) Neighboring Router ID: 166.105.224.104
     (Link Data) Router Interface address: 10.0.0.238
      Number of TOS metrics: 0
       TOS 0 Metrics: 4001

    Link connected to: a Stub Network
     (Link ID) Network/subnet number: 10.0.0.236
     (Link Data) Network Mask: 255.255.255.252
      Number of TOS metrics: 0
       TOS 0 Metrics: 4001

    Link connected to: another Router (point-to-point)
     (Link ID) Neighboring Router ID: 166.105.229.232
     (Link Data) Router Interface address: 10.0.4.54
      Number of TOS metrics: 0
       TOS 0 Metrics: 65500

    Link connected to: a Stub Network
     (Link ID) Network/subnet number: 10.0.4.52
     (Link Data) Network Mask: 255.255.255.252
      Number of TOS metrics: 0
       TOS 0 Metrics: 65500

    Link connected to: another Router (point-to-point)
     (Link ID) Neighboring Router ID: 166.105.229.237
     (Link Data) Router Interface address: 10.0.4.58
      Number of TOS metrics: 0
       TOS 0 Metrics: 4034

    Link connected to: a Stub Network
     (Link ID) Network/subnet number: 10.0.4.56
     (Link Data) Network Mask: 255.255.255.252
      Number of TOS metrics: 0
       TOS 0 Metrics: 4034

    Link connected to: another Router (point-to-point)
     (Link ID) Neighboring Router ID: 166.105.224.108
     (Link Data) Router Interface address: 10.0.0.250
      Number of TOS metrics: 0
       TOS 0 Metrics: 4001

    Link connected to: a Stub Network
     (Link ID) Network/subnet number: 10.0.0.248
     (Link Data) Network Mask: 255.255.255.252
      Number of TOS metrics: 0
       TOS 0 Metrics: 4001

    Link connected to: another Router (point-to-point)
     (Link ID) Neighboring Router ID: 166.105.229.230
     (Link Data) Router Interface address: 10.0.24.134
      Number of TOS metrics: 0
       TOS 0 Metrics: 4014

    Link connected to: a Stub Network
     (Link ID) Network/subnet number: 10.0.24.132
     (Link Data) Network Mask: 255.255.255.252
      Number of TOS metrics: 0
       TOS 0 Metrics: 4014

    Link connected to: another Router (point-to-point)
     (Link ID) Neighboring Router ID: 166.105.224.61
     (Link Data) Router Interface address: 10.0.10.253
      Number of TOS metrics: 0
       TOS 0 Metrics: 8300

    Link connected to: a Stub Network
     (Link ID) Network/subnet number: 10.0.10.252
     (Link Data) Network Mask: 255.255.255.252
      Number of TOS metrics: 0
       TOS 0 Metrics: 8300

    Link connected to: another Router (point-to-point)
     (Link ID) Neighboring Router ID: 166.61.0.145
     (Link Data) Router Interface address: 10.0.12.58
      Number of TOS metrics: 0
       TOS 0 Metrics: 625

    Link connected to: a Stub Network
     (Link ID) Network/subnet number: 10.0.12.56
     (Link Data) Network Mask: 255.255.255.252
      Number of TOS metrics: 0
       TOS 0 Metrics: 625

    Link connected to: another Router (point-to-point)
     (Link ID) Neighboring Router ID: 166.105.224.81
     (Link Data) Router Interface address: 10.0.3.206
      Number of TOS metrics: 0
       TOS 0 Metrics: 1850

    Link connected to: a Stub Network
     (Link ID) Network/subnet number: 10.0.3.204
     (Link Data) Network Mask: 255.255.255.252
      Number of TOS metrics: 0
       TOS 0 Metrics: 1850

    Link connected to: another Router (point-to-point)
     (Link ID) Neighboring Router ID: 166.105.224.59
     (Link Data) Router Interface address: 10.0.3.210
      Number of TOS metrics: 0
       TOS 0 Metrics: 7

    Link connected to: a Stub Network
     (Link ID) Network/subnet number: 10.0.3.208
     (Link Data) Network Mask: 255.255.255.252
      Number of TOS metrics: 0
       TOS 0 Metrics: 7

    Link connected to: another Router (point-to-point)
     (Link ID) Neighboring Router ID: 166.105.224.58
     (Link Data) Router Interface address: 10.0.3.221
      Number of TOS metrics: 0
       TOS 0 Metrics: 6900

    Link connected to: a Stub Network
     (Link ID) Network/subnet number: 10.0.3.220
     (Link Data) Network Mask: 255.255.255.252
      Number of TOS metrics: 0
       TOS 0 Metrics: 6900

    Link connected to: another Router (point-to-point)
     (Link ID) Neighboring Router ID: 166.105.224.95
     (Link Data) Router Interface address: 10.0.3.230
      Number of TOS metrics: 0
       TOS 0 Metrics: 1975

    Link connected to: a Stub Network
     (Link ID) Network/subnet number: 10.0.3.228
     (Link Data) Network Mask: 255.255.255.252
      Number of TOS metrics: 0
       TOS 0 Metrics: 1975

    Link connected to: another Router (point-to-point)
     (Link ID) Neighboring Router ID: 166.105.224.77
     (Link Data) Router Interface address: 10.0.3.238
      Number of TOS metrics: 0
       TOS 0 Metrics: 4100

    Link connected to: a Stub Network
     (Link ID) Network/subnet number: 10.0.3.236
     (Link Data) Network Mask: 255.255.255.252
      Number of TOS metrics: 0
       TOS 0 Metrics: 4100

    Link connected to: another Router (point-to-point)
     (Link ID) Neighboring Router ID: 166.105.224.93
     (Link Data) Router Interface address: 10.0.3.245
      Number of TOS metrics: 0
       TOS 0 Metrics: 550

    Link connected to: a Stub Network
     (Link ID) Network/subnet number: 10.0.3.244
     (Link Data) Network Mask: 255.255.255.252
      Number of TOS metrics: 0
       TOS 0 Metrics: 550

    Link connected to: another Router (point-to-point)
     (Link ID) Neighboring Router ID: 166.105.224.75
     (Link Data) Router Interface address: 10.0.3.253
      Number of TOS metrics: 0
       TOS 0 Metrics: 825

    Link connected to: a Stub Network
     (Link ID) Network/subnet number: 10.0.3.252
     (Link Data) Network Mask: 255.255.255.252
      Number of TOS metrics: 0
       TOS 0 Metrics: 825

    Link connected to: another Router (point-to-point)
     (Link ID) Neighboring Router ID: 166.105.224.87
     (Link Data) Router Interface address: 10.0.4.5
      Number of TOS metrics: 0
       TOS 0 Metrics: 6100

    Link connected to: a Stub Network
     (Link ID) Network/subnet number: 10.0.4.4
     (Link Data) Network Mask: 255.255.255.252
      Number of TOS metrics: 0
       TOS 0 Metrics: 6100

    Link connected to: another Router (point-to-point)
     (Link ID) Neighboring Router ID: 166.105.230.42
     (Link Data) Router Interface address: 10.2.160.50
      Number of TOS metrics: 0
       TOS 0 Metrics: 4269

    Link connected to: a Stub Network
     (Link ID) Network/subnet number: 10.2.160.48
     (Link Data) Network Mask: 255.255.255.252
      Number of TOS metrics: 0
       TOS 0 Metrics: 4269

    Link connected to: another Router (point-to-point)
     (Link ID) Neighboring Router ID: 166.105.224.93
     (Link Data) Router Interface address: 10.0.21.145
      Number of TOS metrics: 0
       TOS 0 Metrics: 550

    Link connected to: a Stub Network
     (Link ID) Network/subnet number: 10.0.21.144
     (Link Data) Network Mask: 255.255.255.252
      Number of TOS metrics: 0
       TOS 0 Metrics: 550

    Link connected to: another Router (point-to-point)
     (Link ID) Neighboring Router ID: 166.105.224.54
     (Link Data) Router Interface address: 10.0.1.94
      Number of TOS metrics: 0
       TOS 0 Metrics: 4021

    Link connected to: a Stub Network
     (Link ID) Network/subnet number: 10.0.1.92
     (Link Data) Network Mask: 255.255.255.252
      Number of TOS metrics: 0
       TOS 0 Metrics: 4021

    Link connected to: a Stub Network
     (Link ID) Network/subnet number: 166.105.224.133
     (Link Data) Network Mask: 255.255.255.255
      Number of TOS metrics: 0
       TOS 0 Metrics: 0
       
gs89e01#show run formal | inc "HundredGigE0/0/0/0|ospf"
Building configuration...
taskgroup priv1 task read ospf
interface HundredGigE0/0/0/0 description **TRK** GS89E01 HundredGigE0/0/0/0 to NV85P02 et-7/0/1.0 BW: 100G CKT: XE#1A#080001 NET: PIP ID: pipdd721 ###
interface HundredGigE0/0/0/0 
interface HundredGigE0/0/0/0 mtu 9216
interface HundredGigE0/0/0/0 service-policy input PE-P_Mark
interface HundredGigE0/0/0/0 service-policy output DSCP_PCR_PE-P_100000000K
interface HundredGigE0/0/0/0 ipv4 address 10.0.1.93 255.255.255.252
interface HundredGigE0/0/0/0 ipv4 unreachables disable
interface HundredGigE0/0/0/0 carrier-delay up 10000 down 60
interface HundredGigE0/0/0/0 dampening 1 1000 1500 4
router ospf 10 nsr
router ospf 10 log adjacency changes
router ospf 10 router-id 166.105.224.54
router ospf 10 mpls ldp sync
router ospf 10 fast-reroute per-prefix
router ospf 10 maximum paths 1
router ospf 10 timers throttle lsa all 50 200 1000
router ospf 10 timers throttle spf 100 200 1000
router ospf 10 timers lsa min-arrival 100
router ospf 10 timers pacing flood 10
router ospf 10 area 0 
router ospf 10 area 0 mpls traffic-eng
router ospf 10 area 0 interface Loopback1 
router ospf 10 area 0 interface Loopback1 passive enable
router ospf 10 area 0 interface HundredGigE0/0/0/0 
router ospf 10 area 0 interface HundredGigE0/0/0/0 bfd minimum-interval 300
router ospf 10 area 0 interface HundredGigE0/0/0/0 bfd fast-detect
router ospf 10 area 0 interface HundredGigE0/0/0/0 bfd multiplier 3
router ospf 10 area 0 interface HundredGigE0/0/0/0 cost 4021
router ospf 10 area 0 interface HundredGigE0/0/0/0 authentication message-digest
router ospf 10 area 0 interface HundredGigE0/0/0/0 message-digest-key 1 md5 encrypted 133607131918242438202C646773
router ospf 10 area 0 interface HundredGigE0/0/0/0 network point-to-point
router ospf 10 area 0 interface HundredGigE0/7/0/0 
router ospf 10 area 0 interface HundredGigE0/7/0/0 bfd minimum-interval 300
router ospf 10 area 0 interface HundredGigE0/7/0/0 bfd fast-detect
router ospf 10 area 0 interface HundredGigE0/7/0/0 bfd multiplier 3
router ospf 10 area 0 interface HundredGigE0/7/0/0 cost 5
router ospf 10 area 0 interface HundredGigE0/7/0/0 authentication message-digest
router ospf 10 area 0 interface HundredGigE0/7/0/0 message-digest-key 1 md5 encrypted 06351F205E5A29171613165C5E54
router ospf 10 area 0 interface HundredGigE0/7/0/0 network point-to-point
router ospf 10 mpls traffic-eng router-id Loopback1
router ospf 10 
rsvp interface HundredGigE0/0/0/0 
rsvp interface HundredGigE0/0/0/0 bandwidth percentage 40
mpls traffic-eng interface HundredGigE0/0/0/0 
mpls traffic-eng interface HundredGigE0/0/0/0 admin-weight 651100
mpls traffic-eng interface HundredGigE0/0/0/0 auto-tunnel backup 
mpls traffic-eng interface HundredGigE0/0/0/0 auto-tunnel backup exclude srlg preferred
mpls ldp interface HundredGigE0/0/0/0 
multicast-routing address-family ipv4 interface HundredGigE0/0/0/0 
multicast-routing address-family ipv4 interface HundredGigE0/0/0/0 enable
router igmp interface HundredGigE0/0/0/0 
router igmp interface HundredGigE0/0/0/0 version 2

---------------------------------------------------------------
